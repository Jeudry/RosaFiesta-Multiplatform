<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-5.0.xsd"
        objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
    <changeSet id="1764873370025-1" author="sargon">
        <createTable schemaName="chat_service" tableName="chat_messages">
            <column name="id" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_chat_messages"/>
            </column>
            <column name="content" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="chat_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="sender_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME"/>
        </createTable>
    </changeSet>
    <changeSet id="1764873370025-2" author="sargon">
        <createTable schemaName="chat_service" tableName="chat_participants">
            <column name="user_id" type="UUID">
                <constraints primaryKey="true" primaryKeyName="pk_chat_participants"/>
            </column>
            <column name="username" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="profile_picture_url" type="TEXT"/>
            <column name="created_at" type="DATETIME"/>
        </createTable>
    </changeSet>
    <changeSet id="1764873370025-3" author="sargon">
        <createTable schemaName="chat_service" tableName="chat_participants_cross_ref">
            <column name="chat_id" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_chat_participants_cross_ref"/>
            </column>
            <column name="participant_id" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_chat_participants_cross_ref"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="1764873370025-4" author="sargon">
        <createTable schemaName="chat_service" tableName="chats">
            <column name="id" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_chats"/>
            </column>
            <column name="creator_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME"/>
        </createTable>
    </changeSet>
    <changeSet id="1764873370025-5" author="sargon">
        <addUniqueConstraint columnNames="email" constraintName="uc_chat_participants_email" schemaName="chat_service"
                             tableName="chat_participants"/>
    </changeSet>
    <changeSet id="1764873370025-6" author="sargon">
        <addUniqueConstraint columnNames="username" constraintName="uc_chat_participants_username"
                             schemaName="chat_service" tableName="chat_participants"/>
    </changeSet>
    <changeSet id="1764873370025-7" author="sargon">
        <createIndex indexName="idx_chat_message_chat_id_created_at" schemaName="chat_service"
                     tableName="chat_messages">
            <column name="chat_id"/>
            <column descending="true" name="created_at"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370025-8" author="sargon">
        <createIndex indexName="idx_chat_participant_email" schemaName="chat_service" tableName="chat_participants">
            <column name="email"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370025-9" author="sargon">
        <createIndex indexName="idx_chat_participant_username" schemaName="chat_service" tableName="chat_participants">
            <column name="username"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370025-10" author="sargon">
        <addForeignKeyConstraint baseColumnNames="creator_id" baseTableName="chats" baseTableSchemaName="chat_service"
                                 constraintName="FK_CHATS_ON_CREATOR" referencedColumnNames="user_id"
                                 referencedTableName="chat_participants" referencedTableSchemaName="chat_service"/>
    </changeSet>
    <changeSet id="1764873370025-11" author="sargon">
        <addForeignKeyConstraint baseColumnNames="chat_id" baseTableName="chat_messages"
                                 baseTableSchemaName="chat_service" constraintName="FK_CHAT_MESSAGES_ON_CHAT"
                                 onDelete="CASCADE" referencedColumnNames="id" referencedTableName="chats"
                                 referencedTableSchemaName="chat_service"/>
    </changeSet>
    <changeSet id="1764873370025-12" author="sargon">
        <addForeignKeyConstraint baseColumnNames="sender_id" baseTableName="chat_messages"
                                 baseTableSchemaName="chat_service" constraintName="FK_CHAT_MESSAGES_ON_SENDER"
                                 referencedColumnNames="user_id" referencedTableName="chat_participants"
                                 referencedTableSchemaName="chat_service"/>
    </changeSet>
    <changeSet id="1764873370025-13" author="sargon">
        <addForeignKeyConstraint baseColumnNames="chat_id" baseTableName="chat_participants_cross_ref"
                                 baseTableSchemaName="chat_service" constraintName="fk_chaparcroref_on_chat_entity"
                                 referencedColumnNames="id" referencedTableName="chats"
                                 referencedTableSchemaName="chat_service"/>
    </changeSet>
    <changeSet id="1764873370025-14" author="sargon">
        <addForeignKeyConstraint baseColumnNames="participant_id" baseTableName="chat_participants_cross_ref"
                                 baseTableSchemaName="chat_service"
                                 constraintName="fk_chaparcroref_on_chat_participant_entity"
                                 referencedColumnNames="user_id" referencedTableName="chat_participants"
                                 referencedTableSchemaName="chat_service"/>
    </changeSet>
    <changeSet id="1764873370182-1" author="sargon">
        <createTable schemaName="user_service" tableName="email_verification_tokens">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_email_verification_tokens"/>
            </column>
            <column name="token" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="used_at" type="DATETIME"/>
            <column name="created_at" type="DATETIME"/>
        </createTable>
    </changeSet>
    <changeSet id="1764873370182-2" author="sargon">
        <createTable schemaName="user_service" tableName="password_reset_tokens">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_password_reset_tokens"/>
            </column>
            <column name="token" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="used_at" type="DATETIME"/>
            <column name="created_at" type="DATETIME"/>
        </createTable>
    </changeSet>
    <changeSet id="1764873370182-3" author="sargon">
        <createTable schemaName="user_service" tableName="refresh_tokens">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_refresh_tokens"/>
            </column>
            <column name="user_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="hashed_token" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME"/>
            <column name="updated_at" type="DATETIME"/>
        </createTable>
    </changeSet>
    <changeSet id="1764873370182-4" author="sargon">
        <createTable schemaName="user_service" tableName="users">
            <column name="id" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_users"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="hashed_password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="has_verified_email" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME"/>
            <column name="updated_at" type="DATETIME"/>
        </createTable>
    </changeSet>
    <changeSet id="1764873370182-5" author="sargon">
        <addUniqueConstraint columnNames="token" constraintName="uc_email_verification_tokens_token"
                             schemaName="user_service" tableName="email_verification_tokens"/>
    </changeSet>
    <changeSet id="1764873370182-6" author="sargon">
        <addUniqueConstraint columnNames="token" constraintName="uc_password_reset_tokens_token"
                             schemaName="user_service" tableName="password_reset_tokens"/>
    </changeSet>
    <changeSet id="1764873370182-7" author="sargon">
        <addUniqueConstraint columnNames="email" constraintName="uc_users_email" schemaName="user_service"
                             tableName="users"/>
    </changeSet>
    <changeSet id="1764873370182-8" author="sargon">
        <addUniqueConstraint columnNames="username" constraintName="uc_users_username" schemaName="user_service"
                             tableName="users"/>
    </changeSet>
    <changeSet id="1764873370182-9" author="sargon">
        <createIndex indexName="idx_password_reset_token_token" schemaName="user_service"
                     tableName="password_reset_tokens">
            <column name="token"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370182-10" author="sargon">
        <createIndex indexName="idx_refresh_tokens_user_id" schemaName="user_service" tableName="refresh_tokens">
            <column name="user_id"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370182-11" author="sargon">
        <createIndex indexName="idx_refresh_tokens_user_token" schemaName="user_service" tableName="refresh_tokens">
            <column name="user_id"/>
            <column name="hashed_token"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370182-12" author="sargon">
        <createIndex indexName="idx_users_email" schemaName="user_service" tableName="users">
            <column name="email"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370182-13" author="sargon">
        <createIndex indexName="idx_users_username" schemaName="user_service" tableName="users">
            <column name="username"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370182-14" author="sargon">
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="email_verification_tokens"
                                 baseTableSchemaName="user_service"
                                 constraintName="FK_EMAIL_VERIFICATION_TOKENS_ON_USER" referencedColumnNames="id"
                                 referencedTableName="users" referencedTableSchemaName="user_service"/>
    </changeSet>
    <changeSet id="1764873370182-15" author="sargon">
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="password_reset_tokens"
                                 baseTableSchemaName="user_service" constraintName="FK_PASSWORD_RESET_TOKENS_ON_USER"
                                 referencedColumnNames="id" referencedTableName="users"
                                 referencedTableSchemaName="user_service"/>
    </changeSet>
    <changeSet id="1764873370332-1" author="sargon">
        <createTable schemaName="notification_service" tableName="device_tokens">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_device_tokens"/>
            </column>
            <column name="user_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="token" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="platform" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATETIME"/>
        </createTable>
    </changeSet>
    <changeSet id="1764873370332-2" author="sargon">
        <createIndex indexName="idx_device_tokens_token" schemaName="notification_service" tableName="device_tokens"
                     unique="true">
            <column name="token"/>
        </createIndex>
    </changeSet>
    <changeSet id="1764873370332-3" author="sargon">
        <createIndex indexName="idx_device_tokens_user_id" schemaName="notification_service" tableName="device_tokens">
            <column name="user_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>